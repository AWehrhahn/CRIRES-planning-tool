
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>crires_planning_tool.transit_planner &#8212; CRIRES+ Planning Tool 0.1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for crires_planning_tool.transit_planner</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Does all the transit planning</span>

<span class="sd">@author: Ansgar Wehrhahn</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>


<span class="kn">import</span> <span class="nn">astroplan</span> <span class="k">as</span> <span class="nn">ap</span>
<span class="kn">import</span> <span class="nn">dateparser</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.utils.exceptions</span> <span class="kn">import</span> <span class="n">AstropyWarning</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.interactive_graph</span> <span class="kn">import</span> <span class="n">create_interactive_graph</span>
    <span class="kn">from</span> <span class="nn">.nasa_exoplanets_archive</span> <span class="kn">import</span> <span class="n">NasaExoplanetsArchive</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__console__</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">interactive_graph</span> <span class="kn">import</span> <span class="n">create_interactive_graph</span>
    <span class="kn">from</span> <span class="nn">nasa_exoplanets_archive</span> <span class="kn">import</span> <span class="n">NasaExoplanetsArchive</span>
    <span class="kn">from</span> <span class="nn">__init__</span> <span class="kn">import</span> <span class="n">__console__</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="set_verbose_level"><a class="viewcode-back" href="../../crires_planning_tool.html#crires_planning_tool.transit_planner.set_verbose_level">[docs]</a><span class="k">def</span> <span class="nf">set_verbose_level</span><span class="p">(</span><span class="n">verbose</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span>
    <span class="k">elif</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
    <span class="k">elif</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">!=</span> <span class="n">__console__</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
        <span class="n">__console__</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">AstropyWarning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;once&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">AstropyWarning</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_default_constraints"><a class="viewcode-back" href="../../crires_planning_tool.html#crires_planning_tool.transit_planner.get_default_constraints">[docs]</a><span class="k">def</span> <span class="nf">get_default_constraints</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines the default constraints if none are explicitly set.</span>
<span class="sd">    Those are Altitude above 30 deg, airmass less than 1.7, </span>
<span class="sd">    astronomical twilight at the observing location, and at </span>
<span class="sd">    least 45 deg seperation from the moon</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    constraints : list</span>
<span class="sd">        list of constraints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Altitude constraints definition</span>
    <span class="n">altcons</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=+</span><span class="mi">30</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Airmass constraints definition</span>
    <span class="n">airmasscons</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">AirmassConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.7</span><span class="p">)</span>

    <span class="c1"># Astronomical Nighttime constraints definition:</span>
    <span class="c1"># begin and end of each night at paranal as</span>
    <span class="c1"># AtNightConstraint.twilight_astronomical</span>
    <span class="n">night_cons_per_night</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">AtNightConstraint</span><span class="o">.</span><span class="n">twilight_astronomical</span><span class="p">()</span>

    <span class="c1"># Moon Constraint</span>
    <span class="n">mooncons</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">MoonSeparationConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=+</span><span class="mi">45</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">night_cons_per_night</span><span class="p">,</span> <span class="n">altcons</span><span class="p">,</span> <span class="n">airmasscons</span><span class="p">,</span> <span class="n">mooncons</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">constraints</span></div>


<div class="viewcode-block" id="calculate_airmass"><a class="viewcode-back" href="../../crires_planning_tool.html#crires_planning_tool.transit_planner.calculate_airmass">[docs]</a><span class="k">def</span> <span class="nf">calculate_airmass</span><span class="p">(</span><span class="n">obstime</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the airmass at obstime</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obstime : Time</span>
<span class="sd">        observation times</span>
<span class="sd">    observer : astroplan.Observer</span>
<span class="sd">        telescope location</span>
<span class="sd">    target : astroplan.FixedTarget</span>
<span class="sd">        Star location</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    airmass : Quantity</span>
<span class="sd">        airmass at obstime</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">altaz</span> <span class="o">=</span> <span class="n">observer</span><span class="o">.</span><span class="n">altaz</span><span class="p">(</span><span class="n">obstime</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">altaz</span><span class="o">.</span><span class="n">secz</span>
    <span class="k">return</span> <span class="n">airmass</span></div>


<div class="viewcode-block" id="estimate_snr"><a class="viewcode-back" href="../../crires_planning_tool.html#crires_planning_tool.transit_planner.estimate_snr">[docs]</a><span class="nd">@u</span><span class="o">.</span><span class="n">quantity_input</span>
<span class="k">def</span> <span class="nf">estimate_snr</span><span class="p">(</span>
    <span class="n">magnitude</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">mag</span><span class="p">,</span> <span class="n">exptime</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">airmass</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;crires&quot;</span><span class="p">,</span> <span class="n">mband</span><span class="o">=</span><span class="s2">&quot;K&quot;</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes SNR of stellar spectrum from magnitude, exposure time (in seconds) and airmass</span>
<span class="sd">    @author fabian lesjak</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    magnitude : Quantity</span>
<span class="sd">        stellar magnitude in the band specified by mband</span>
<span class="sd">    exptime : Quantity</span>
<span class="sd">        exposure time</span>
<span class="sd">    airmass : Quantity</span>
<span class="sd">        airmass</span>
<span class="sd">    method : {&quot;crires&quot;, &quot;carmenes&quot;}, optional</span>
<span class="sd">        which formula to use, by default &quot;crires&quot;</span>
<span class="sd">    mband : str, optional</span>
<span class="sd">        which spectral band to use, by default &quot;K&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    snr : Quantity</span>
<span class="sd">        Signal to Noise Ratio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># SNR with airmass = 1</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
    <span class="n">et</span> <span class="o">=</span> <span class="n">exptime</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
    <span class="n">am</span> <span class="o">=</span> <span class="n">airmass</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">one</span><span class="p">)</span>

    <span class="c1"># This is from old Carmenes documentation, factor 1.1774 so that it agrees better with Ansgars result</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;carmenes&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mband</span> <span class="o">==</span> <span class="s2">&quot;J&quot;</span><span class="p">:</span>
            <span class="n">snr</span> <span class="o">=</span> <span class="mf">1.1774</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">((</span><span class="n">mag</span> <span class="o">-</span> <span class="mf">4.2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.5</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">et</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Use Jmag for calculation of Carmenes SNR.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;crires&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mband</span> <span class="o">==</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span>
            <span class="n">snr</span> <span class="o">=</span> <span class="mf">449.4241</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">mag</span> <span class="o">/</span> <span class="mf">2.5</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">et</span><span class="p">)</span> <span class="o">-</span> <span class="mf">6.3144</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Use Kmag for calculation of Crires SNR.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method not recognized. Use Crires or Carmenes.&quot;</span><span class="p">)</span>

    <span class="c1"># Scale to airmass = airm</span>
    <span class="n">extcof</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># extinction coefficient, see Lombardi et al., 2018</span>
    <span class="n">snr</span> <span class="o">*=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">extcof</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">airmass</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">snr</span></div>


<div class="viewcode-block" id="single_planet"><a class="viewcode-back" href="../../crires_planning_tool.html#crires_planning_tool.transit_planner.single_planet">[docs]</a><span class="k">def</span> <span class="nf">single_planet</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">date_end</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs the observability and SNR estimation for a single planet</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : dict</span>
<span class="sd">        data for this planet</span>
<span class="sd">    date_start : Time</span>
<span class="sd">        start date</span>
<span class="sd">    date_end : Time</span>
<span class="sd">        end date</span>
<span class="sd">    constraints : list</span>
<span class="sd">        list of observability constraints</span>
<span class="sd">    observer : astroplan.Observer</span>
<span class="sd">        telescope location</span>
<span class="sd">    verbose : int, optional</span>
<span class="sd">        how much information to print, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : dict</span>
<span class="sd">        contains everything about this planet, one entry per observable transit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">set_verbose_level</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>

    <span class="n">primary_eclipse_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pl_tranmid&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;jd&quot;</span><span class="p">)</span>
    <span class="n">orbital_period</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pl_orbper&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span>
    <span class="n">eclipse_duration</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pl_trandur&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pl_name&quot;</span><span class="p">]</span>
    <span class="c1"># Update the progress bar</span>
    <span class="c1"># Define the target coordinates</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">FixedTarget</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># Define the star-planet system</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">EclipsingSystem</span><span class="p">(</span>
        <span class="n">primary_eclipse_time</span><span class="o">=</span><span class="n">primary_eclipse_time</span><span class="p">,</span>
        <span class="n">orbital_period</span><span class="o">=</span><span class="n">orbital_period</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">eclipse_duration</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Find all eclipses of this system</span>
    <span class="n">n_max_eclipses</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_end</span> <span class="o">-</span> <span class="n">date_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">orbital_period</span>
    <span class="n">n_max_eclipses</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_max_eclipses</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">eclipses</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">next_primary_ingress_egress_time</span><span class="p">(</span>
        <span class="n">date_start</span><span class="p">,</span> <span class="n">n_eclipses</span><span class="o">=</span><span class="n">n_max_eclipses</span>
    <span class="p">)</span>
    <span class="c1"># If the last eclipse is past the final date, just cut it off</span>
    <span class="k">if</span> <span class="n">eclipses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">date_end</span><span class="p">:</span>
        <span class="n">eclipses</span> <span class="o">=</span> <span class="n">eclipses</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eclipses</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No observable transits found for planet </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Check if they are observable</span>
    <span class="n">is_observable</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">is_event_observable</span><span class="p">(</span>
        <span class="n">constraints</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">times_ingress_egress</span><span class="o">=</span><span class="n">eclipses</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">observable_eclipses</span> <span class="o">=</span> <span class="n">eclipses</span><span class="p">[</span><span class="n">is_observable</span><span class="p">]</span>
    <span class="n">n_eclipses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">observable_eclipses</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_eclipses</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No observable transits found for planet </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Calculate the SNR for those that are left</span>
    <span class="n">magnitude</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sy_kmag&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mag</span>
    <span class="n">exptime</span> <span class="o">=</span> <span class="n">eclipse_duration</span>
    <span class="c1"># exptime = np.diff(observable_eclipses.jd, axis=1).ravel() * u.day</span>
    <span class="n">obstime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observable_eclipses</span><span class="o">.</span><span class="n">jd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;jd&quot;</span><span class="p">)</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">calculate_airmass</span><span class="p">(</span><span class="n">obstime</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="n">estimate_snr</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">exptime</span><span class="p">,</span> <span class="n">airmass</span><span class="p">)</span>

    <span class="c1"># Save results for later</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_eclipses</span><span class="p">,</span>
        <span class="s2">&quot;snr&quot;</span><span class="p">:</span> <span class="n">snr</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;exptime&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">eclipse_duration</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n_eclipses</span><span class="p">,</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">obstime</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span>
        <span class="s2">&quot;time_begin&quot;</span><span class="p">:</span> <span class="n">observable_eclipses</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="s2">&quot;time_end&quot;</span><span class="p">:</span> <span class="n">observable_eclipses</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="s2">&quot;stellar_effective_temperature&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;st_teff&quot;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">n_eclipses</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="transit_calculation"><a class="viewcode-back" href="../../crires_planning_tool.html#crires_planning_tool.transit_planner.transit_calculation">[docs]</a><span class="k">def</span> <span class="nf">transit_calculation</span><span class="p">(</span>
    <span class="n">planets_or_criteria</span><span class="p">,</span>
    <span class="n">date_start</span><span class="p">,</span>
    <span class="n">date_end</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">observer</span><span class="o">=</span><span class="s2">&quot;paranal&quot;</span><span class="p">,</span>
    <span class="n">catalog</span><span class="o">=</span><span class="s2">&quot;nexa&quot;</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;planets&quot;</span><span class="p">,</span>
    <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the SNR of all observable transits for one or more planets between two times</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    planets : list, str</span>
<span class="sd">        planet names in the format &#39;star letter&#39;</span>
<span class="sd">    date_start : Time</span>
<span class="sd">        earliest time for a possible transit</span>
<span class="sd">    date_end : Time</span>
<span class="sd">        last time for a possible transit</span>
<span class="sd">    constraints : list, optional</span>
<span class="sd">        list of astroplan constraints. If not set uses a set of reasonable constraints.</span>
<span class="sd">    observer : str, ap.Observer, optional</span>
<span class="sd">        the location of the observatory/telescope, by default &quot;paranal&quot;</span>
<span class="sd">    catalog : str, optional</span>
<span class="sd">        the name of the data catalog, by default &quot;nexa&quot;, which stands for the Nasa Exoplanet Archive</span>
<span class="sd">    verbose : int, optional</span>
<span class="sd">        amount of information displayed during runtime, 0 (default), 1 (some info), 2 (technical details), -1 (none)</span>
<span class="sd">    parallel : bool, optional</span>
<span class="sd">        if True will perform the observability and SNR calculation for all planets in parallel, by default True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        the results with one entry per transit</span>
<span class="sd">        entries are</span>
<span class="sd">        - name: name of the star and planet letter</span>
<span class="sd">        - snr: estimated snr for this transit</span>
<span class="sd">        - exptime: exposure time in seconds</span>
<span class="sd">        - time: mid transit time in MJD</span>
<span class="sd">        - time_begin: ingress time in MJD</span>
<span class="sd">        - time_end: egress time in MJD</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">set_verbose_level</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;planets&quot;</span><span class="p">,</span>
        <span class="s2">&quot;criteria&quot;</span><span class="p">,</span>
    <span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Expected one of [&#39;planets&#39;, &#39;criteria&#39;], but got </span><span class="si">{mode}</span><span class="s2"> for parameter &#39;mode&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">catalog</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;nexa&quot;</span>
    <span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Expected one of [&#39;nexa&#39;,], but got </span><span class="si">{catalog}</span><span class="s2"> for parameter &#39;catalog&#39;&quot;</span>

    <span class="c1"># Fix the inputs to match our expectations</span>
    <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">get_default_constraints</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">ap</span><span class="o">.</span><span class="n">Observer</span><span class="p">):</span>
        <span class="n">observer</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">at_site</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">planets_or_criteria</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">planets_or_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="n">planets_or_criteria</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">planets_or_criteria</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;criteria&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No criteria were set for the observation, using default values instead. Set &#39;planets_or_criteria&#39; to an empty list if you want to use all planets instead [].&quot;</span>
            <span class="p">)</span>
            <span class="n">planets_or_criteria</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;pl_bmassj &lt; 1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dec &lt; 10&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sy_jmag &lt; 10&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sy_hmag &lt; 10&quot;</span><span class="p">,</span>
                <span class="s2">&quot;st_teff &lt; 6000&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Expected type str or list for parameter &#39;planets_or_criteria&#39;, but got None&quot;</span>
            <span class="p">)</span>

    <span class="n">date_start</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">date_start</span><span class="p">)</span>
    <span class="n">date_end</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">date_end</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">date_start</span> <span class="o">&lt;</span> <span class="n">date_end</span><span class="p">,</span> <span class="s2">&quot;Starting date must be earlier than the end date&quot;</span>

    <span class="n">observer_name</span> <span class="o">=</span> <span class="n">observer</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">observer</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">observer</span><span class="o">.</span><span class="n">location</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating observable transits for planets: </span><span class="si">{planets_or_criteria}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;between </span><span class="si">{date_start}</span><span class="s2"> and </span><span class="si">{date_end}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;at observing location </span><span class="si">{observer_name}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using data catalog </span><span class="si">{catalog}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">catalog</span> <span class="o">==</span> <span class="s2">&quot;nexa&quot;</span><span class="p">:</span>
        <span class="c1"># TODO: this is slow, add a cache?</span>
        <span class="n">nexa</span> <span class="o">=</span> <span class="n">NasaExoplanetsArchive</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;planets&quot;</span><span class="p">:</span>
            <span class="n">catalog</span> <span class="o">=</span> <span class="n">nexa</span><span class="o">.</span><span class="n">query_objects</span><span class="p">(</span><span class="n">planets_or_criteria</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;criteria&quot;</span><span class="p">:</span>
            <span class="n">catalog</span> <span class="o">=</span> <span class="n">nexa</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">planets_or_criteria</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>

    <span class="c1"># Drop masked values</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;pl_tranmid&quot;</span><span class="p">])</span>
    <span class="n">mask</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;pl_orbper&quot;</span><span class="p">])</span>
    <span class="n">mask</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;pl_trandur&quot;</span><span class="p">])</span>
    <span class="n">mask</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;sy_kmag&quot;</span><span class="p">])</span>
    <span class="n">mask</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;st_teff&quot;</span><span class="p">])</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Successfully loaded planet data from catalog and found {len(catalog)} potential planets&quot;</span>
    <span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;snr&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;exptime&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;time_begin&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;time_end&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;stellar_effective_temperature&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">catalog</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span>
                    <span class="n">date_start</span><span class="p">,</span>
                    <span class="n">date_end</span><span class="p">,</span>
                    <span class="n">constraints</span><span class="p">,</span>
                    <span class="n">observer</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">futures</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                        <span class="n">single_planet</span><span class="p">,</span>
                        <span class="n">data</span><span class="p">,</span>
                        <span class="n">date_start</span><span class="p">,</span>
                        <span class="n">date_end</span><span class="p">,</span>
                        <span class="n">constraints</span><span class="p">,</span>
                        <span class="n">observer</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Planets&quot;</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span>
                <span class="n">disable</span><span class="o">=</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">results_single</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">results_single</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">results_single</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Planets&quot;</span><span class="p">):</span>
            <span class="n">results_single</span> <span class="o">=</span> <span class="n">single_planet</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">date_end</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">verbose</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">results_single</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">results_single</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>

    <span class="c1"># Store everything in a dataframe</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No observable transits found&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">results</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../crires_planning_tool.html#crires_planning_tool.transit_planner.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command line interface for the crires planning tool</span>
<span class="sd">    all parameters are set via sys.argv</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        The dataframe containing all observable transits</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="s2">&quot;crires-planning-tool&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;CRIRES+ planning tool to determine the observable transits of one or more planets&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Add all arguments</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;begin&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">dateparser</span><span class="o">.</span><span class="n">parse</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;first date to check for transits&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">dateparser</span><span class="o">.</span><span class="n">parse</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;last date to check for transits&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;planets&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Names of the planets to calculate in the format &#39;star letter&#39;. &quot;</span>
            <span class="s2">&quot;If just the name of the star is given it will get all the planets of &quot;</span>
            <span class="s2">&quot;that system. If mode is set to &#39;criteria&#39; this defines the criteria &quot;</span>
            <span class="s2">&quot;instead of the planets, look at the NASA Exoplanet Archive documentation &quot;</span>
            <span class="s2">&quot;of the TAP interface for available criteria.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-O&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--observer&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Location of the observer, by default &#39;paranal&#39;. This can be any name supported by astropy.&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;paranal&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--catalog&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the data catalog to use, by default &#39;nexa&#39; (Nasa Exoplanet Archive)&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;nexa&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--mode&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Which mode to use &#39;planets&#39; or &#39;criteria&#39;. In mode &#39;planets&#39; we &quot;</span>
            <span class="s2">&quot;define the specific planets to investigate, in mode &#39;criteria&#39; we &quot;</span>
            <span class="s2">&quot;specify conditions that the stars and planets need to fullfill.&quot;</span>
        <span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;planets&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--output&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save the data to this file&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--file&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Load planet names from a file instead, one planet name per line. &quot;</span>
            <span class="s2">&quot;Lines starting with # are considered comments&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--plot&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set will create an interactive plot&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--plot-file-1&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;filename for the first plot&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--plot-file-2&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;filename for the second plot&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;verbosity level up to -vv&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--silent&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;removes all console output, except for errors&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Process the arguments</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">planets</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">planets</span>
    <span class="n">date_start</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">begin</span>
    <span class="n">date_end</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">end</span>
    <span class="n">observer</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">observer</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">catalog</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">plot</span>
    <span class="n">plot_file_1</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_file_1</span>
    <span class="n">plot_file_2</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_file_2</span>
    <span class="k">if</span> <span class="n">plot_file_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">plot_file_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">planets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading input planets/criteria from file </span><span class="si">{filename}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">planets</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">planets</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">planets</span><span class="p">]</span>
            <span class="n">planets</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">planets</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">planets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">planets</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Run the main method</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">transit_calculation</span><span class="p">(</span>
        <span class="n">planets</span><span class="p">,</span>
        <span class="n">date_start</span><span class="p">,</span>
        <span class="n">date_end</span><span class="p">,</span>
        <span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span>
        <span class="n">catalog</span><span class="o">=</span><span class="n">catalog</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Output as desired</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored results in file </span><span class="si">{output}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># for verbose &gt;= 1, we already print it in the method</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">create_interactive_graph</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">plot_file_1</span><span class="p">,</span> <span class="n">plot_file_2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">CRIRES+ Planning Tool</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/command_line.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crires_planning_tool.html">crires_planning_tool package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Ansgar Wehrhahn, Linn Boldt-Christmas, Jonas Zbinden.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>